# Feature Specification: Web Dashboard

**Feature Branch**: `002-web-dashboard`
**Created**: 2025-12-17
**Status**: Draft
**Input**: 웹 배포 대시보드 - Cloudflare Tunnel + Streamlit 기반 실시간 모니터링 및 비상정지 기능

## Clarifications

*(None at this time - spec is complete)*

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 비상정지 제어 (Priority: P1)

운영자가 웹 대시보드에서 비상정지 버튼을 클릭하여 즉시 모든 신규 진입을 차단하고, 재개 버튼으로 거래를 다시 활성화할 수 있다. 이는 시장 급변 또는 시스템 이상 시 손실을 방지하는 핵심 안전장치이다.

**Why this priority**: 거래 시스템에서 비상정지는 금전적 손실을 방지하는 가장 중요한 기능. 다른 모든 기능보다 우선.

**Independent Test**: 비상정지 버튼 클릭 시 즉시 상태가 변경되고, 신규 진입이 차단되는지 확인. 재개 버튼으로 정상 복귀 확인.

**Acceptance Scenarios**:

1. **Given** 시스템이 정상 거래 중, **When** 운영자가 비상정지 버튼 클릭, **Then** 즉시 비상정지 상태로 전환되고 신규 진입이 차단된다.
2. **Given** 비상정지 상태, **When** 운영자가 재개 버튼 클릭, **Then** 정상 거래 상태로 복귀한다.
3. **Given** 비상정지 활성화, **When** 청산 조건 충족, **Then** 청산은 정상적으로 실행된다 (청산은 차단하지 않음).
4. **Given** 비상정지 상태 변경, **When** 변경 완료, **Then** Telegram으로 알림이 발송된다.

---

### User Story 2 - 실시간 포지션 모니터링 (Priority: P2)

운영자가 웹 대시보드에서 현재 포지션 상태, 손익 현황, 김프율을 실시간으로 확인할 수 있다. 외부에서 모바일로도 동일한 정보를 확인할 수 있어야 한다.

**Why this priority**: 포지션과 손익 파악은 거래 운영의 핵심. 비상정지 다음으로 중요.

**Independent Test**: 대시보드 접속 시 현재 포지션, 손익, 김프율이 표시되고, 10초 내에 최신 데이터로 갱신되는지 확인.

**Acceptance Scenarios**:

1. **Given** 오픈 포지션 존재, **When** 대시보드 접속, **Then** 업비트/바이낸스 포지션 수량, 진입가, 현재 평가액이 표시된다.
2. **Given** 포지션 존재, **When** 손익 섹션 확인, **Then** 김프 차익, 펀딩비, 수수료, 순이익이 표시된다.
3. **Given** 데이터 수집 중, **When** 10초 경과, **Then** 김프율 차트와 현재값이 자동 갱신된다.
4. **Given** 모바일 기기 접속, **When** 대시보드 로드, **Then** 반응형 레이아웃으로 동일 정보가 표시된다.

---

### User Story 3 - 안전한 외부 접근 (Priority: P3)

운영자가 인터넷을 통해 어디서나 대시보드에 접근할 수 있되, 인증된 사용자만 접근 가능해야 한다. 서버 포트를 직접 노출하지 않고 보안을 유지한다.

**Why this priority**: 외부 접근은 운영 편의성의 핵심이지만, 보안 없이는 위험. 기능과 보안의 균형.

**Independent Test**: 외부 네트워크에서 대시보드 URL 접속 시 인증 화면이 표시되고, 인증 후에만 대시보드가 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 미인증 사용자, **When** 대시보드 URL 접속, **Then** 인증 화면이 표시된다.
2. **Given** 인증 화면, **When** 허용된 이메일로 OTP 인증, **Then** 대시보드에 접근할 수 있다.
3. **Given** 허용되지 않은 이메일, **When** OTP 인증 시도, **Then** 접근이 거부된다.
4. **Given** 인증 완료, **When** 24시간 경과, **Then** 재인증이 필요하다.

---

### User Story 4 - 시스템 상태 모니터링 (Priority: P4)

운영자가 거래소 API 연결 상태, 데이터 수집 상태, 최근 에러 현황을 확인하여 시스템 건강 상태를 파악할 수 있다.

**Why this priority**: 시스템 장애 조기 발견으로 문제 확대 방지.

**Independent Test**: 대시보드에서 각 거래소 연결 상태와 응답 시간이 표시되고, 에러 발생 시 빨간색으로 표시되는지 확인.

**Acceptance Scenarios**:

1. **Given** 모든 API 정상, **When** 상태 섹션 확인, **Then** 업비트, 바이낸스, 환율 API가 녹색으로 표시된다.
2. **Given** 특정 API 연결 실패, **When** 상태 섹션 확인, **Then** 해당 API가 빨간색으로 표시되고 에러 메시지가 표시된다.
3. **Given** 최근 1시간 에러 발생, **When** 상태 섹션 확인, **Then** 에러 건수가 표시된다.

---

### User Story 5 - 거래 이력 조회 (Priority: P5)

운영자가 최근 거래 이력을 확인하여 거래 실행 현황을 파악할 수 있다.

**Why this priority**: 거래 이력은 분석 및 감사에 필요하지만, 실시간 운영보다 우선순위 낮음.

**Independent Test**: 최근 10건의 거래가 시간순으로 표시되고, 거래소, 액션, 수량, 가격이 포함되는지 확인.

**Acceptance Scenarios**:

1. **Given** 거래 이력 존재, **When** 거래 이력 섹션 확인, **Then** 최근 10건의 거래가 시간 역순으로 표시된다.
2. **Given** 거래 기록, **When** 각 항목 확인, **Then** 시간, 거래소, 액션(BUY/SELL/SHORT/COVER), 수량, 가격이 표시된다.

---

### Edge Cases

- 인터넷 연결 끊김 시 어떻게 처리하는가? (마지막 데이터 유지 + 연결 끊김 표시)
- 비상정지 버튼 중복 클릭 시 어떻게 처리하는가? (멱등성 보장, 이미 정지 상태면 무시)
- 인증 세션 만료 중 비상정지 필요 시? (즉시 재인증 가능해야 함)
- 대시보드 서버 다운 시? (기존 collector는 독립적으로 동작, Telegram으로 비상정지 가능해야 함)

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 시스템은 웹 대시보드를 통해 비상정지를 활성화/비활성화할 수 있어야 한다
- **FR-002**: 비상정지 활성화 시 모든 신규 진입이 즉시 차단되어야 한다
- **FR-003**: 비상정지 상태에서도 청산 조건 충족 시 청산은 실행되어야 한다
- **FR-004**: 시스템은 현재 포지션 정보(수량, 진입가, 평가액)를 실시간으로 표시해야 한다
- **FR-005**: 시스템은 손익 현황(김프 차익, 펀딩비, 수수료, 순이익)을 표시해야 한다
- **FR-006**: 시스템은 김프율 추이를 차트로 표시해야 한다
- **FR-007**: 시스템은 PC와 모바일에서 동일하게 동작하는 반응형 UI를 제공해야 한다
- **FR-008**: 시스템은 인증된 사용자만 대시보드에 접근할 수 있도록 해야 한다
- **FR-009**: 시스템은 거래소 API 연결 상태를 표시해야 한다
- **FR-010**: 시스템은 최근 거래 이력을 표시해야 한다
- **FR-011**: 시스템은 비상정지 상태 변경 시 Telegram 알림을 발송해야 한다
- **FR-012**: 시스템은 서버 포트를 외부에 직접 노출하지 않고 안전하게 접근을 제공해야 한다

### Key Entities

- **EmergencyStop**: 비상정지 상태. 활성화 여부, 활성화 시간, 사유 포함
- **Position**: 현재 포지션 정보. 거래소별 수량, 진입가, 평가액 포함
- **SystemStatus**: 시스템 연결 상태. 거래소별 상태, 응답 시간, 에러 정보 포함
- **Trade**: 거래 기록. 시간, 거래소, 액션, 수량, 가격 포함

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 비상정지 활성화 후 1초 이내에 Supabase에 상태가 반영되고, 모든 신규 진입이 차단된다 (측정: Supabase updated_at 타임스탬프 기준)
- **SC-002**: 대시보드 데이터는 10초 이내에 자동 갱신된다
- **SC-003**: 외부 네트워크에서 대시보드 접속 시 5초 이내에 인증 화면이 표시된다
- **SC-004**: 인증된 사용자는 PC와 모바일에서 동일한 기능을 사용할 수 있다
- **SC-005**: 시스템 상태 표시가 실제 연결 상태와 10초 이내 오차로 동기화된다
- **SC-006**: 비상정지 상태 변경 시 10초 이내에 Telegram 알림이 발송된다
- **SC-007**: 대시보드는 인터넷 어디서나 접근 가능하되, 서버 포트는 외부에 노출되지 않는다

## Assumptions

- Vultr 서버(64.176.229.30)에 기존 kimptrade Collector 시스템이 운영 중
- **Dashboard는 별도 Vultr 서버에 배포 (Collector와 장애 격리)**
- Supabase에 기존 테이블(kimp_1m, positions, trades, fx_rates)이 존재
- **system_status 테이블 추가 필요 (비상정지 상태 저장)**
- Cloudflare 계정 보유 및 도메인 DNS가 Cloudflare에 연결됨
- Telegram Bot이 이미 설정되어 있음 (기존 알림 시스템)
- 운영자는 1-2명의 허용된 이메일 사용자로 제한
